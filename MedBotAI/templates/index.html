<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MedBot AI - Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.0/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --background: 220 10% 4%;
      --foreground: 213 31% 91%;
      --card: 224 71% 4%;
      --card-foreground: 213 31% 91%;
      --popover: 224 71% 4%;
      --popover-foreground: 215 20.2% 65.1%;
      --primary: 210 40% 50%;
      --primary-foreground: 222.2 47.4% 11.2%;
      --secondary: 222.2 47.4% 11.2%;
      --secondary-foreground: 210 40% 98%;
      --muted: 223 47% 11%;
      --muted-foreground: 215 20.2% 65.1%;
      --accent: 216 34% 17%;
      --accent-foreground: 210 40% 98%;
      --destructive: 0 63% 31%;
      --destructive-foreground: 210 40% 98%;
      --border: 216 34% 17%;
      --input: 216 34% 17%;
      --ring: 224 76% 48%;
      --radius: 0.5rem;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --background: 0 0% 100%;
        --foreground: 240 10% 3.9%;
        --card: 0 0% 100%;
        --card-foreground: 240 10% 3.9%;
        --popover: 0 0% 100%;
        --popover-foreground: 240 10% 3.9%;
        --primary: 221.2 83.2% 53.3%;
        --primary-foreground: 210 40% 98%;
        --secondary: 240 4.8% 95.9%;
        --secondary-foreground: 240 5.9% 10%;
        --muted: 240 4.8% 95.9%;
        --muted-foreground: 240 3.8% 46.1%;
        --accent: 240 4.8% 95.9%;
        --accent-foreground: 240 5.9% 10%;
        --destructive: 0 84.2% 60.2%;
        --destructive-foreground: 0 0% 98%;
        --border: 240 5.9% 90%;
        --input: 240 5.9% 90%;
        --ring: 240 5.9% 10%;
      }
    }

    * {
      border-color: hsl(var(--border));
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: hsl(var(--background));
      color: hsl(var(--foreground));
      min-height: 100vh;
    }

    .chat-container {
      background-color: hsl(var(--card));
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .chat-messages {
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      background-color: hsl(var(--card));
    }

    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: var(--radius);
    }

    .user-message {
      background-color: hsl(var(--primary));
      color: hsl(var(--primary-foreground));
      margin-left: 20px;
      border-radius: 15px 15px 0 15px;
    }

    .bot-message {
      background-color: hsl(var(--accent));
      color: hsl(var(--accent-foreground));
      margin-right: 20px;
      border-radius: 15px 15px 15px 0;
    }

    .input-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      font-weight: 500;
      font-size: 0.875rem;
      line-height: 1.25rem;
      height: 2.5rem;
      padding-left: 1rem;
      padding-right: 1rem;
      transition-property: color, background-color, border-color;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 150ms;
    }

    .btn-primary {
      background-color: hsl(var(--primary));
      color: hsl(var(--primary-foreground));
    }

    .btn-primary:hover {
      background-color: hsl(var(--primary) / 0.9);
    }

    .btn-secondary {
      background-color: hsl(var(--secondary));
      color: hsl(var(--secondary-foreground));
    }

    .btn-secondary:hover {
      background-color: hsl(var(--secondary) / 0.8);
    }

    .input {
      display: flex;
      height: 2.5rem;
      width: 100%;
      border-radius: var(--radius);
      border: 1px solid hsl(var(--input));
      background-color: transparent;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
      font-size: 0.875rem;
      transition-property: border-color, box-shadow;
      transition-duration: 150ms;
    }

    .input:focus {
      outline: none;
      box-shadow: 0 0 0 2px hsl(var(--ring));
      border-color: hsl(var(--ring));
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 8px 12px;
    }

    .typing-indicator-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: hsl(var(--primary-foreground) / 0.7);
      animation: typing 1.4s infinite both;
    }

    .typing-indicator-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-5px);
      }
    }

    .gradient-bg {
      background: radial-gradient(circle at top right, hsl(var(--accent)), transparent 70%),
        radial-gradient(circle at bottom left, hsl(var(--primary) / 0.2), transparent 70%);
    }

    .navbar {
      background-color: hsl(var(--card));
      border-bottom: 1px solid hsl(var(--border));
    }

    .navbar-brand {
      font-weight: bold;
      color: hsl(var(--foreground));
    }

    .card {
      border-radius: var(--radius);
      background-color: hsl(var(--card));
      color: hsl(var(--card-foreground));
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }

    .nav-tabs {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-radius: var(--radius);
      background-color: hsl(var(--card));
      padding: 0.5rem;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }

    .nav-tab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius);
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .nav-tab:hover {
      background-color: hsl(var(--accent));
      color: hsl(var(--accent-foreground));
    }

    .nav-tab.active {
      background-color: hsl(var(--primary));
      color: hsl(var(--primary-foreground));
    }
  </style>
</head>
<body class="gradient-bg">
  <nav class="navbar p-4">
    <div class="container mx-auto flex justify-between items-center">
      <a class="navbar-brand flex items-center gap-2" href="/">
        <i class="fas fa-robot text-primary"></i>
        <span class="text-xl">MedBot AI</span>
      </a>
    </div>
  </nav>

  <div class="container mx-auto p-4">
    <div class="nav-tabs mx-auto max-w-2xl mb-8">
      <a href="/" class="nav-tab">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="/chat" class="nav-tab active">
        <i class="fas fa-comments"></i>
        <span>Chat</span>
      </a>
      <a href="/flashcard" class="nav-tab">
        <i class="fas fa-clone"></i>
        <span>Flashcards</span>
      </a>
      <a href="/exam" class="nav-tab">
        <i class="fas fa-file-alt"></i>
        <span>Practice Exams</span>
      </a>
      <a href="/calendar" class="nav-tab">
        <i class="fas fa-calendar-alt"></i>
        <span>Study Planner</span>
      </a>
    </div>

    <div class="chat-container p-6 rounded-lg">
      <h1 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <i class="fas fa-comments text-primary"></i>
        Medical Chatbot
      </h1>
      
      <div class="chat-messages p-4 mb-6" id="chat-messages">
        <div class="message bot-message">
          <p>Hello! I'm MedBot AI, your medical education assistant. How can I help you today?</p>
        </div>
        <!-- Messages will be added here dynamically -->
      </div>
      
      <div id="typing-indicator" class="typing-indicator hidden">
        <div class="typing-indicator-dot"></div>
        <div class="typing-indicator-dot"></div>
        <div class="typing-indicator-dot"></div>
      </div>
      
      <div class="input-container">
        <div class="flex items-center gap-2 mb-2">
          <label for="context-toggle" class="flex items-center cursor-pointer">
            <div class="relative">
              <input type="checkbox" id="context-toggle" class="sr-only" checked>
              <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
              <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
            </div>
            <div class="ml-3 text-sm font-medium">
              Use Course Context
            </div>
          </label>
        </div>
        
        <div class="flex gap-2">
          <textarea id="user-input" class="input h-auto min-h-[80px] p-3 w-full" placeholder="Ask me anything about medicine..."></textarea>
          <div class="flex flex-col gap-2">
            <button id="send-button" class="btn btn-primary">
              <i class="fas fa-paper-plane mr-2"></i>Send
            </button>
            <button id="stop-button" class="btn btn-secondary hidden">
              <i class="fas fa-stop mr-2"></i>Stop
            </button>
          </div>
        </div>
        
        <div class="mt-4">
          <div class="flex items-center gap-2 mb-2">
            <label for="file-upload" class="btn btn-secondary cursor-pointer">
              <i class="fas fa-file-upload mr-2"></i>Upload PDF
            </label>
            <input type="file" id="file-upload" accept=".pdf" class="hidden">
            <span id="file-name" class="text-sm text-muted-foreground"></span>
          </div>
          <div id="upload-status" class="mt-2 text-sm"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const chatMessages = document.getElementById('chat-messages');
    const typingIndicator = document.getElementById('typing-indicator');
    const stopButton = document.getElementById('stop-button');
    let lastResponse = '';
    let currentFileId = null;
    let controller = null;

    // Add event listener for stop button
    stopButton.addEventListener('click', stopResponseGeneration);

    function appendMessage(text, isUser = false) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message', isUser ? 'user-message' : 'bot-message');
      msgDiv.textContent = text;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function stopResponseGeneration() {
      if (controller) {
        controller.abort();
        controller = null;
        stopButton.style.display = 'none';
        typingIndicator.style.display = 'none';
      }
    }

    async function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      if (!message) return;

      // Clean up any previous response generation
      if (controller) {
        controller.abort();
      }

      // Create a new AbortController
      controller = new AbortController();
      const signal = controller.signal;

      input.value = '';
      appendMessage(message, true);

      typingIndicator.style.display = 'block';
      stopButton.style.display = 'inline-block';

      try {
        const useRag = document.getElementById('use-rag').checked;
        
        const response = await fetch('/chat/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message,
            file_id: currentFileId,
            use_rag: useRag
          }),
          signal: signal
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let botMsgDiv = document.createElement('div');
        botMsgDiv.classList.add('message', 'bot-message');
        chatMessages.appendChild(botMsgDiv);

        let fullText = '';

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, {stream:true});
          fullText += chunk;
          botMsgDiv.textContent = fullText;
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        lastResponse = fullText;
      } catch (error) {
        if (error.name !== 'AbortError') {
          appendMessage(`Error: ${error.message}`, false);
        }
      } finally {
        typingIndicator.style.display = 'none';
        stopButton.style.display = 'none';
        controller = null;
      }
    }

    // Function to speak the last response
    async function speakLastResponse() {
      if (!lastResponse) return;
      
      // Show loading indicator
      const notification = document.createElement('div');
      notification.id = 'speech-notification';
      notification.style.padding = '10px';
      notification.style.margin = '10px 0';
      notification.style.backgroundColor = '#cce5ff';
      notification.style.border = '1px solid #b8daff';
      notification.style.borderRadius = '5px';
      notification.style.color = '#004085';
      notification.textContent = 'Generating AI voice...';
      
      // Add the notification before the input container
      const inputContainer = document.querySelector('.input-container');
      inputContainer.parentNode.insertBefore(notification, inputContainer);
      
      try {
        const voice = document.getElementById('voice-select').value;
        const resp = await fetch('/chat/speak', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: lastResponse, voice })
        });
        
        if (!resp.ok) {
          throw new Error(`Server responded with ${resp.status}: ${resp.statusText}`);
        }
        
        const data = await resp.json();
        
        if (data.audio_url) {
          // Update notification
          notification.textContent = 'Playing AI voice...';
          notification.style.backgroundColor = '#d4edda';
          notification.style.border = '1px solid #c3e6cb';
          notification.style.color = '#155724';
          
          // Add stop button
          const stopButton = document.createElement('button');
          stopButton.textContent = 'Stop';
          stopButton.style.marginLeft = '10px';
          stopButton.style.padding = '5px 10px';
          stopButton.style.backgroundColor = '#dc3545';
          stopButton.style.color = 'white';
          stopButton.style.border = 'none';
          stopButton.style.borderRadius = '3px';
          stopButton.style.cursor = 'pointer';
          
          // Create audio element
          const audio = new Audio(data.audio_url + '?t=' + new Date().getTime());
          
          // Set up stop button
          stopButton.onclick = () => {
            audio.pause();
            audio.currentTime = 0;
            notification.remove();
          };
          notification.appendChild(stopButton);
          
          // Set up audio events
          audio.onerror = (e) => {
            console.error("Audio error:", e);
            notification.textContent = 'Error playing audio';
            notification.style.backgroundColor = '#f8d7da';
            notification.style.border = '1px solid #f5c6cb';
            notification.style.color = '#721c24';
            setTimeout(() => notification.remove(), 3000);
          };
          
          audio.onended = () => {
            notification.remove();
          };
          
          // Play the audio
          await audio.play();
        } else {
          throw new Error('No audio URL in response');
        }
      } catch (error) {
        console.error('TTS error:', error);
        
        // Update notification to show error
        notification.textContent = `Error: ${error.message}`;
        notification.style.backgroundColor = '#f8d7da';
        notification.style.border = '1px solid #f5c6cb';
        notification.style.color = '#721c24';
        
        // Remove after 3 seconds
        setTimeout(() => {
          if (document.getElementById('speech-notification')) {
            document.getElementById('speech-notification').remove();
          }
        }, 3000);
      }
    }

    // Send on Enter (no shift)
    document.getElementById('user-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Initial greeting
    appendMessage("Hello! I'm MedBot AI, your medical assistant. How can I help you today?", false);

    // Voice Call Functions
    let recognition;
    let audioPlayer;
    let isListening = false;
    let isSpeaking = false;

    function startVoiceCall() {
      // Show the voice call modal
      document.querySelector('.voice-call-modal').style.display = 'flex';
      
      // Initialize speech recognition
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        recognition.onstart = function() {
          isListening = true;
          document.querySelector('.voice-indicator').classList.add('listening');
          document.querySelector('.voice-status').textContent = 'Listening...';
        };
        
        recognition.onresult = function(event) {
          const transcript = Array.from(event.results)
            .map(result => result[0])
            .map(result => result.transcript)
            .join('');
          
          document.querySelector('.voice-transcript').textContent = transcript;
          
          // If this is a final result, send it to the chatbot
          if (event.results[0].isFinal) {
            sendVoiceMessage(transcript);
          }
        };
        
        recognition.onerror = function(event) {
          console.error('Speech recognition error', event.error);
          document.querySelector('.voice-status').textContent = 'Error: ' + event.error;
          stopListening();
        };
        
        recognition.onend = function() {
          if (isListening) {
            // If we're still in listening mode but recognition ended, restart it
            recognition.start();
          } else {
            document.querySelector('.voice-indicator').classList.remove('listening');
            document.querySelector('.voice-status').textContent = 'Waiting for AI response...';
          }
        };
      } else {
        alert('Speech recognition is not supported in your browser. Please try Chrome or Edge.');
        closeVoiceCall();
      }
      
      // Set up event listeners for the buttons
      document.querySelector('.start-listening-button').addEventListener('click', startListening);
      document.querySelector('.end-call-button').addEventListener('click', closeVoiceCall);
    }
    
    function startListening() {
      if (!isListening && !isSpeaking) {
        try {
          recognition.start();
          document.querySelector('.start-listening-button').textContent = 'Stop Listening';
        } catch (error) {
          console.error('Error starting recognition:', error);
        }
      } else if (isListening) {
        stopListening();
      }
    }
    
    function stopListening() {
      if (isListening) {
        isListening = false;
        try {
          recognition.stop();
        } catch (error) {
          console.error('Error stopping recognition:', error);
        }
        document.querySelector('.start-listening-button').textContent = 'Start Listening';
        document.querySelector('.voice-indicator').classList.remove('listening');
      }
    }
    
    function sendVoiceMessage(message) {
      stopListening();
      document.querySelector('.voice-status').textContent = 'Sending message...';
      
      // Add the user message to the chat
      addMessage('user', message);
      
      // Send the message to the chatbot
      fetch('/chat/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let botMsgDiv = document.createElement('div');
        botMsgDiv.classList.add('message', 'bot-message');
        chatMessages.appendChild(botMsgDiv);
        
        let fullText = '';
        
        // Function to process the stream
        function processStream() {
          return reader.read().then(({ value, done }) => {
            if (done) {
              // When stream is complete, update lastResponse and speak
              lastResponse = fullText;
              document.querySelector('.voice-status').textContent = 'Response received';
              speakVoiceResponse(fullText);
              return;
            }
            
            // Decode and append the chunk
            const chunk = decoder.decode(value, {stream: true});
            fullText += chunk;
            botMsgDiv.textContent = fullText;
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Continue reading
            return processStream();
          });
        }
        
        // Start processing the stream
        return processStream();
      })
      .catch(error => {
        console.error('Error:', error);
        document.querySelector('.voice-status').textContent = 'Error: Could not get response';
        appendMessage(`Error: ${error.message}`, false);
      });
    }
    
    function speakVoiceResponse(text) {
      document.querySelector('.voice-status').textContent = 'Generating voice...';
      document.querySelector('.voice-indicator').classList.add('speaking');
      
      // Get the selected voice
      const voiceSelect = document.getElementById('voice-select');
      const selectedVoice = voiceSelect.value;
      
      // Send request to generate speech
      fetch('/chat/speak', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          text: text,
          voice: selectedVoice
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.audio_url) {
          playAudioResponse(data.audio_url);
        } else {
          document.querySelector('.voice-status').textContent = 'Voice unavailable';
          document.querySelector('.voice-indicator').classList.remove('speaking');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        document.querySelector('.voice-status').textContent = 'Error generating voice';
        document.querySelector('.voice-indicator').classList.remove('speaking');
      });
    }
    
    function playAudioResponse(audioUrl) {
      isSpeaking = true;
      document.querySelector('.voice-status').textContent = 'Speaking...';
      
      // Create audio element if it doesn't exist
      if (!audioPlayer) {
        audioPlayer = new Audio();
        
        audioPlayer.onended = function() {
          audioFinished();
        };
        
        audioPlayer.onerror = function() {
          console.error('Audio playback error');
          audioFinished();
        };
      }
      
      // Set the source and play
      audioPlayer.src = audioUrl;
      audioPlayer.play().catch(error => {
        console.error('Error playing audio:', error);
        audioFinished();
      });
    }
    
    function audioFinished() {
      isSpeaking = false;
      document.querySelector('.voice-indicator').classList.remove('speaking');
      document.querySelector('.voice-status').textContent = 'Ready to listen';
      document.querySelector('.start-listening-button').textContent = 'Start Listening';
    }
    
    function closeVoiceCall() {
      // Stop any ongoing processes
      stopListening();
      
      if (audioPlayer && !audioPlayer.paused) {
        audioPlayer.pause();
      }
      
      // Reset the UI
      document.querySelector('.voice-transcript').textContent = '';
      document.querySelector('.voice-status').textContent = 'Ready to start';
      document.querySelector('.voice-indicator').classList.remove('listening', 'speaking');
      
      // Hide the modal
      document.querySelector('.voice-call-modal').style.display = 'none';
      
      // Remove event listeners
      document.querySelector('.start-listening-button').removeEventListener('click', startListening);
      document.querySelector('.end-call-button').removeEventListener('click', closeVoiceCall);
    }

    // Function to add a message to the chat
    function addMessage(sender, message) {
      // Add message to the chat UI
      if (sender === 'user') {
        appendMessage(message, true);
      } else {
        appendMessage(message, false);
        lastResponse = message;
      }
    }

    // Initialize the chat
    document.addEventListener('DOMContentLoaded', function() {
      // Add initial greeting
      appendMessage("Hello! I'm MedBot AI, your medical assistant. How can I help you today?", false);
      
      // Set up file upload event listeners
      setupFileUpload();
    });
    
    // File upload handling
    function setupFileUpload() {
      const fileInput = document.getElementById('file-upload');
      const fileNameSpan = document.getElementById('file-name');
      const removeFileButton = document.getElementById('remove-file');
      
      fileInput.addEventListener('change', async function(e) {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          fileNameSpan.textContent = file.name;
          removeFileButton.style.display = 'inline-block';
          
          // Upload the file
          const formData = new FormData();
          formData.append('file', file);
          
          try {
            const response = await fetch('/chat/upload', {
              method: 'POST',
              body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
              currentFileId = data.file_id;
              appendMessage(`File uploaded: ${data.filename}${data.context_added ? ' (Added to context)' : ''}`, false);
            } else {
              appendMessage(`Error uploading file: ${data.error}`, false);
              resetFileUpload();
            }
          } catch (error) {
            console.error('Error uploading file:', error);
            appendMessage(`Error uploading file: ${error.message}`, false);
            resetFileUpload();
          }
        }
      });
      
      removeFileButton.addEventListener('click', function() {
        resetFileUpload();
        appendMessage('File removed from context', false);
      });
    }
    
    function resetFileUpload() {
      const fileInput = document.getElementById('file-upload');
      const fileNameSpan = document.getElementById('file-name');
      const removeFileButton = document.getElementById('remove-file');
      
      fileInput.value = '';
      fileNameSpan.textContent = '';
      removeFileButton.style.display = 'none';
      currentFileId = null;
    }
  </script>
</body>
</html>
